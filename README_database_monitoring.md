# 資料庫監控與檔案上傳驗證指南

## 概述

本指南提供多種方法來監控您的 Render.com PostgreSQL 資料庫和驗證檔案上傳狀態，即使在使用免費版本的情況下。

## 方法一：透過管理員儀表板 (推薦)

### 1. 訪問管理員儀表板
- 登入您的管理員帳戶
- 訪問 `/admin` 頁面
- 點擊「資料庫監控」標籤

### 2. 可用的監控功能

#### 資料庫統計資訊
- **使用者統計**: 總使用者數、管理員數、一般使用者數
- **檔案統計**: 總檔案數、處理中檔案、已完成檔案、已過期檔案
- **使用記錄統計**: 總使用次數、影片摘要次數、語音簡報次數
- **最近活動**: 24小時內的檔案上傳和使用記錄

#### 最近上傳檔案
- 顯示最近上傳的檔案列表
- 包含檔案名稱、使用者、類型、大小、狀態、上傳時間
- 可以點擊「驗證」按鈕檢查檔案狀態

#### 檔案驗證功能
- 檢查檔案是否實際存在於檔案系統
- 驗證檔案大小是否與資料庫記錄匹配
- 檢查檔案是否過期
- 顯示剩餘有效天數

## 方法二：使用命令行工具

### 1. 設置環境
確保您的 `.env` 檔案包含正確的 `DATABASE_URL`：
```
DATABASE_URL=postgresql://username:password@host:port/database
```

### 2. 安裝依賴
```bash
cd backend
pip install psycopg2-binary python-dotenv
```

### 3. 使用查詢工具

#### 查看資料庫統計
```bash
python db_query_tool.py stats
```

#### 查看最近上傳的檔案
```bash
python db_query_tool.py recent 20  # 顯示最近20個檔案
```

#### 查看特定使用者的活動
```bash
python db_query_tool.py user user@example.com
```

#### 驗證特定檔案
```bash
python db_query_tool.py verify 123  # 驗證檔案ID為123的檔案
```

## 方法三：透過 API 端點

### 1. 資料庫統計 API
```
GET /api/admin/database-stats
```
需要管理員權限，返回完整的資料庫統計資訊。

### 2. 最近上傳檔案 API
```
GET /api/admin/recent-uploads?limit=20
```
返回最近上傳的檔案列表。

### 3. 使用者活動 API
```
GET /api/admin/user-activity/{user_email}
```
返回特定使用者的完整活動記錄。

### 4. 檔案驗證 API
```
GET /api/admin/verify-upload/{file_id}
```
驗證特定檔案的上傳狀態和完整性。

## 驗證檔案上傳的方法

### 1. 檢查資料庫記錄
- 確認檔案記錄存在於 `user_files` 表中
- 檢查檔案狀態 (`processing`, `completed`, `expired`)
- 驗證檔案大小和上傳時間

### 2. 檢查檔案系統
- 確認檔案實際存在於伺服器上
- 驗證檔案大小與資料庫記錄一致
- 檢查檔案權限和可讀性

### 3. 檢查檔案完整性
- 驗證檔案路徑是否正確
- 檢查檔案是否未損壞
- 確認檔案格式是否正確

## 常見問題與解決方案

### Q: 如何確認使用者真的上傳了檔案？
A: 使用以下方法驗證：
1. 檢查資料庫中的 `user_files` 記錄
2. 驗證檔案是否實際存在於檔案系統
3. 檢查檔案大小是否與上傳記錄一致
4. 查看使用記錄 (`usage_records`) 確認服務使用

### Q: 免費版本的資料庫限制是什麼？
A: Render.com 免費版本的 PostgreSQL 資料庫：
- 無法直接通過 GUI 工具訪問
- 只能通過程式碼或 API 查詢
- 有存儲空間限制
- 有連接數限制

### Q: 如何監控資料庫使用情況？
A: 使用提供的工具：
1. 管理員儀表板查看即時統計
2. 命令行工具定期檢查
3. 設置自動化腳本監控關鍵指標

### Q: 檔案上傳失敗怎麼辦？
A: 檢查以下項目：
1. 檔案大小是否超過限制 (50MB)
2. 使用者是否達到每日使用限制 (5次)
3. 檔案格式是否支援
4. 伺服器存儲空間是否充足

## 自動化監控建議

### 1. 定期檢查腳本
創建一個定期執行的腳本來監控關鍵指標：
```bash
# 每天檢查一次
0 9 * * * cd /path/to/backend && python db_query_tool.py stats >> /var/log/db_monitor.log
```

### 2. 設置警報
當以下情況發生時發送通知：
- 檔案上傳失敗率過高
- 資料庫存儲空間不足
- 異常的使用模式

### 3. 備份策略
- 定期備份重要的檔案記錄
- 導出使用者活動數據
- 保存系統日誌

## 安全注意事項

1. **保護管理員權限**: 確保只有授權人員可以訪問管理員功能
2. **API 安全**: 所有管理員 API 都需要驗證管理員權限
3. **資料保護**: 不要在前端顯示敏感的檔案路徑資訊
4. **日誌管理**: 定期清理過期的日誌檔案

## 故障排除

### 連接資料庫失敗
- 檢查 `DATABASE_URL` 環境變數
- 確認網路連接
- 驗證資料庫憑證

### API 請求失敗
- 檢查 JWT token 是否有效
- 確認管理員權限
- 查看伺服器日誌

### 檔案驗證失敗
- 檢查檔案路徑是否正確
- 確認檔案權限
- 驗證檔案系統空間

## 聯繫支援

如果您遇到技術問題或需要進一步的協助，請：
1. 檢查本文件的故障排除部分
2. 查看應用程式日誌
3. 使用提供的工具進行診斷
4. 聯繫技術支援團隊 